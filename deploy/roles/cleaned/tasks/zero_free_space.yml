---

- name: Restart device
  ansible.builtin.reboot:

- name: Discard unused blocks (trim)
  ansible.builtin.command: 'fstrim -a'
  changed_when: true

- name: Overwrite empty space
  ansible.builtin.command: 'dd if=/dev/zero of=/opt/zero_file bs=8M'
  failed_when: false  # will write zeros until it fails
  changed_when: true

- name: Remove empty space file
  ansible.builtin.file:
    path: '/opt/zero_file'
    state: absent
  register: rm_zero_ret
  until: rm_zero_ret is not failed
  retries: 5

- name: Sync
  ansible.builtin.command: 'sync'
  changed_when: true

- name: Discard unused blocks (trim)
  ansible.builtin.command: 'fstrim -a'
  changed_when: true
