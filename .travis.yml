language: c

services:
  - docker

addons:
  apt:
    packages:
     - sshpass

script:
 - export PROJECT_DIR=$PWD
 - cd software/packaging
 - docker build -t shepherd-builder-img .
 - docker create -it --name shepherd-builder shepherd-builder-img
 - docker cp $PROJECT_DIR/software shepherd-builder:/code
 - docker start -a shepherd-builder
 - docker cp shepherd-builder:/artifacts $PROJECT_DIR/
 - cd $PROJECT_DIR

before_deploy:
 - cd $PROJECT_DIR/software/shepherd-herd

deploy:
 - provider: script
   script: SSHPASS=$DEPLOY_PASS sshpass -e scp -v -o StrictHostKeyChecking=no $PROJECT_DIR/artifacts/debian/* $DEPLOY_USER@$DEPLOY_HOST:shepherd/debian/

 - provider: pypi
   user: $PYPI_USER
   password: $PYPI_PASS
